---
title: "Script_SEMGSUS"
output: html_document
date: "2025-09-23"
---

```{r setup}
p_needed <- c("PanelMatch", "wbstats", "jsonlite", "vdemdata", "countrycode", "dplyr", "tidyr", "slider", "tibble", "ggplot2", 'haven',
              'wpp2024', 'MASS', 'glue')
packages <- rownames(installed.packages())
p_to_install <- p_needed[!(p_needed %in% packages)]
if (length(p_to_install) > 0) {
  install.packages(p_to_install)
}
sapply(p_needed, require, character.only = TRUE)
options(warn=-1)
```

```{r directory}
setwd("~/Desktop/Работа и учеба/Semichev_Guseinov_Inequality") # set your own wd if needed
```

```{r acemoglu data}
# load Acemoglu et al. data
DDCGdata_final <- read_dta("DDCGdata_final.dta")
DDCGdata_final <- as.data.frame(DDCGdata_final)
```

```{r loading data}
# Inequality measures
gini_wb_classic <- wb_data("SI.POV.GINI", start_date = 1960, end_date = 2010) # from 1963, World Bank data
gini_wb_classic_2 <- gini_wb_classic %>%
  mutate(wbcode = countrycode(iso3c, "iso3c", "wb")) %>%
  rename(year = date) %>%
  dplyr::select(wbcode, year, SI.POV.GINI)
gini_wb_pip <- read.csv("https://ourworldindata.org/grapher/economic-inequality-gini-index.csv?v=1&csvType=full&useColumnShortNames=true") # from 1963
gini_wb_pip_2 <- gini_wb_pip %>%
  mutate(wbcode = countrycode(Code, "iso3c", "wb")) %>%
  rename(year = Year, gini_wb_pip = gini__ppp_version_2021__poverty_line_no_poverty_line__welfare_type_income_or_consumption__table_income_or_consumption_consolidated__survey_comparability_no_spells) %>%
  dplyr::select(wbcode, year, gini_wb_pip) # from 1963, World Bank Poverty and Inequality Platform, income inequality

vdemdata::vdem -> vdem
vdem_vars <- vdem %>%
  mutate(wbcode = countrycode(country_name, "country.name", "wb")) %>%
  filter(year %in% c(1900:2019)) %>%
  dplyr::select(wbcode, year, v2pehealth, v2peedueq, v2xeg_eqdr, v2x_polyarchy) # health equality, educational equality, equal distribution of resources index

data(pop1dt)
population <- pop1dt %>% 
  mutate(wbcode = countrycode(name, 'country.name', 'wb'),
         pop = round(pop)) %>% 
  #drop_na(cow) %>% 
  filter(year %in% c(1900:2019)) %>% 
  dplyr::select(wbcode, year, pop)

gdp_gapminder <- read.csv("gdp_gapminder.csv", sep=";")
gdp_gapminder <- reshape2::melt(gdp_gapminder, 
                                id.vars = c("geo", "Country.Name"), 
                                variable.name = "year", 
                                value.name = "value")
gdp_gapminder$year = gsub("X", "", as.factor(gdp_gapminder$year))
gdp_gapminder$ISO3C <- toupper(gdp_gapminder$geo)
gdp_gapminder <- gdp_gapminder %>% 
  mutate(ISO3C = countrycode(ISO3C, "iso3c", "iso3c"),
                wbcode = countrycode(ISO3C, 'iso3c', 'wb')) %>% 
  rename(gdp_pcap = value) %>%
  #drop_na(cow) %>%
  filter(year %in% c(1950:2013)) %>% 
  dplyr::select(wbcode, year, gdp_pcap)
gdp_gapminder <- gdp_gapminder %>%
  mutate(gdp_pcap = as.numeric(gdp_pcap)) %>% 
  arrange(wbcode, year) %>%
  group_by(wbcode) %>% 
  mutate(gdp_growth = ((gdp_pcap - dplyr::lag(gdp_pcap)) / dplyr::lag(gdp_pcap) * 100)) %>%  # Compute growth rate
  ungroup()

# Add NAVCO 1.3
NAVCO1.3_regr <- read.csv("NAVCO1.3_default.csv", sep = ",")
NAVCO1.3_regr <- NAVCO1.3_regr %>%
  mutate(
    year = BYEAR,
    wbcode = countrycode(LOCATION, "country.name", "wb")
  ) %>%
  dplyr::rename(
    start_year = BYEAR,
    end_year = EYEAR,
    NVC1.3_event_name = CAMPAIGNNAME,
    NVC1.3_campaign = NVC1.3_CAMPAIGN
  ) %>%
  drop_na(wbcode) %>%
  dplyr::select(!c(LOCATION, NVC1.3_event_name))
```

```{r merging}
df1 <- merge(DDCGdata_final, NAVCO1.3_regr, by = c("wbcode", "year"), all.x = TRUE)
df2 <- merge(df1, gini_wb_classic_2, by = c("wbcode", "year"), all.x = TRUE)
df3 <- merge(df2, gini_wb_pip_2, by = c("wbcode", "year"), all.x = TRUE)
df4 <- merge(df3, population, by = c("wbcode", "year"), all.x = TRUE)
df5 <- merge(df4, gdp_gapminder, by = c("wbcode", "year"), all.x = TRUE)
df6 <- merge(df5, vdem_vars, by = c("wbcode", "year"), all.x = TRUE) %>% mutate_at(
  vars(starts_with("NVC1.3_")),
  ~ replace_na(., 0)
)
```


```{r final data}
df_semgus <- df6 %>%
  group_by(wbcode) %>%
  arrange(year) %>%
  mutate(
    gdp_pcap = log(gdp_pcap + 1),
    pop = log(pop + 1),
    success_dem_5yr = ifelse(
      NVC1.3_SUCCESS == 1 &
        (
          slide_sum(yeardem, after = 5) > 0
        ),
      1,
      0
    ),
    failed_autoc_5yr = ifelse(
      NVC1.3_FAILURE == 1 &
        (
          slide_sum(yearrev, after = 5) > 0
        ),
      1,
      0
    ),
    dem_without_revolution =
      ifelse(
        yeardem == 1 &
          (
            ifelse(success_dem_5yr == 1, 0, 1)
          ),
        1,
        0
      ),
    autoc_without_revolution =
      ifelse(
        yearrev == 1 &
          (
            ifelse(failed_autoc_5yr == 1, 0, 1)
          ),
        1,
        0
      ),
    regime_change = ifelse(success_dem_5yr + dem_without_revolution >= 1, 1, 0),
    NVC1.3_nonviolsucc = ifelse(NVC1.3_NONVIOL == 1 & NVC1.3_SUCCESS == 1, 1, 0),
    NVC1.3_violsucc = ifelse(NVC1.3_VIOL == 1 & NVC1.3_SUCCESS == 1, 1, 0),
    NVC1.3_violfailed = ifelse(NVC1.3_VIOL == 1 & NVC1.3_FAILURE == 1, 1, 0),
    v2xeg_eqdr_growth = ((v2xeg_eqdr - dplyr::lag(v2xeg_eqdr)) / dplyr::lag(v2xeg_eqdr) * 100),
    v2peedueq_growth = ((v2peedueq - dplyr::lag(v2peedueq)) / dplyr::lag(v2peedueq) * 100),
    v2pehealth_growth = ((v2pehealth - dplyr::lag(v2pehealth)) / dplyr::lag(v2pehealth) * 100)
  ) %>%
  ungroup() %>%
  mutate_at(
    vars(yeardem, success_dem_5yr, dem_without_revolution, regime_change),
    # v2x_polyarchy_l, vdem_growth_l, gdp_growth_l, youthbulge_l, gdp_pcap_l, pop_l, v2x_execorr_l,
    # gdp_pcap_l, SP.URB.TOTL_l, NY.GDP.TOTL.RT.ZS_l),
    ~ replace_na(., 0)
  )

df_semgus <- df_semgus[!duplicated(df_semgus[c("wbcode2", "year")]), ]
df_semgus <- as.data.frame(df_semgus)
```

Some descriptive statistics
```{r desc 1}
df_semgus %>% dplyr::filter(success_dem_5yr == 1) %>% dplyr::select(wbcode, year, success_dem_5yr) #всё ок, корректно отображает успешные революции, в течение 5 лет после которых произошла демократизация
```

```{r desc 2}
df_semgus %>% dplyr::filter(failed_autoc_5yr == 1) %>% dplyr::select(wbcode, year, failed_autoc_5yr) #аналогично
```

```{r desc 3}
df_semgus %>% dplyr::select(wbcode, year, NVC1.3_NONVIOL, NVC1.3_SUCCESS)
```

```{r desc 4}
table(df_semgus$NVC1.3_NONVIOL, df_semgus$success_dem_5yr)
table(df_semgus$NVC1.3_nonviolsucc, df_semgus$success_dem_5yr) #большинство демократизирующих успехов - ненасильственные кампании
table(df_semgus$NVC1.3_VIOL, df_semgus$failed_autoc_5yr) #очень мало кейсов провальных насильственных кампаний, которые привели к автократизации (происходили в уже автократиях)
table(df_semgus$NVC1.3_NONVIOL, df_semgus$failed_autoc_5yr) 
```
Процент пропусков у Джини
```{r}
sum(is.na(df_semgus$SI.POV.GINI)) / nrow(df_semgus) * 100
sum(is.na(df_semgus$gini_wb_pip)) / nrow(df_semgus) * 100
```

```{r PanelMatch function for one variable}
PM_output_fun_onevar <- function(df = df_semgus, countrycode = 'wbcode2', time = 'year', x, y){
  df = as.data.frame(df)
  df_PM = PanelData(df, countrycode, time, x, y)
  
  PM.results <- PanelMatch(lag = 4,
                           panel.data = df_PM,
                           refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
                            covs.formula = as.formula(
  paste0("~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4)) +
          I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(", y, ", 1:4))")
),
                            size.match = 10, qoi = "att",
                            lead = 0:10, forbid.treatment.reversal = FALSE,
                            placebo.test = T)
  
  PE.results <- PanelEstimate(
  sets = PM.results, panel.data = df_PM,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T
)
  
  panmatch <- PE.results$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results$estimate %>% as.data.frame(),
    PE.results$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

  
  return(list(get_covariate_balance(PM.results,
          panel.data = df_PM,
          covariates = c(
            "v2x_polyarchy", "gdp_pcap", "pop", y
          )
),
  ggplot(panmatch, aes(x = t, y = E)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    title = "ATT",
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1))
  ))
}
```


```{r function for several variables}
PM_output_fun_manyvar <- function(df = df_semgus, countrycode = 'wbcode2', time = 'year', x, y){
  df = as.data.frame(df)
  df_list = list()
  
  for (i in y){
  df_PM = PanelData(df, countrycode, time, x, i)
  
  PM.results <- PanelMatch(lag = 4,
                           panel.data = df_PM,
                           refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
                            covs.formula = as.formula(
  paste0("~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4)) +
          I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(", i, ", 1:4))")
),
                            size.match = 10, qoi = "att",
                            lead = 0:10, forbid.treatment.reversal = FALSE,
                            placebo.test = T)
  
  PE.results <- PanelEstimate(
  sets = PM.results, panel.data = df_PM,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T
)
  
  panmatch <- PE.results$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results$estimate %>% as.data.frame(),
    PE.results$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)
  
  panmatch$type = i
  
  df_list[[i]] = panmatch}
  
  panmatch_fin = bind_rows(df_list[[1]], df_list[[2]], df_list[[3]])
  
  return(list(
      get_covariate_balance(PM.results,
          panel.data = df_PM,
          covariates = c(
            "v2x_polyarchy", "gdp_pcap", "pop", i
          )
),  
  ggplot(panmatch_fin, aes(x = t, y = E, color = type)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    title = "ATT",
    #subtitle = 'Only 3 campaigns are violent',
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1))
  ))
}
```

```{r manyvar function test}
output <- PM_output_fun_manyvar(df = df_semgus, countrycode = 'wbcode2', time = 'year', x = 'success_dem_5yr', y = c('v2xeg_eqdr', 'v2pehealth', 'v2peedueq'))
output[[1]]
output[[2]]
```


```{r onevar function test}
output <- PM_output_fun_onevar(df = df_semgus, countrycode = 'wbcode2', time = 'year', x = 'success_dem_5yr', y = 'v2xeg_eqdr')
output[[1]]
output[[2]]
#PM_output_fun_onevar(df = df_semgus, countrycode = 'wbcode2', time = 'year', x = 'success_dem_5yr', y = 'v2pehealth')
#PM_output_fun_onevar(df = df_semgus, countrycode = 'wbcode2', time = 'year', x = 'success_dem_5yr', y = 'v2peedueq')
```


PanelMatch section. Successful democratizing campaigns - all VDEM types of inequality
```{r, PM1}
df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2xeg_eqdr")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2pehealth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2peedueq")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2peedueq, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr$type = "Equal resources distribution"
panmatch_success_health$type = 'Equal healthcare'
panmatch_success_educ$type = 'Equal education'
panmatch_vis = bind_rows(panmatch_eqdr, panmatch_success_health, panmatch_success_educ)

ggplot(panmatch_vis, aes(x = t, y = E, color = type)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    title = "ATT of democratizing successful campaigns",
    subtitle = 'Only 3 campaigns are violent',
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1))
```

```{r, PM1_delta}
df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2xeg_eqdr_growth")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr_growth, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr", "v2xeg_eqdr_growth"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2pehealth_growth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2pehealth_growth, 1:4)) + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth", "v2pehealth_growth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2peedueq_growth")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2peedueq, 1:4)) + I(lag(v2peedueq_growth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq", "v2peedueq_growth"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr$type = "Equal resources distribution"
panmatch_success_health$type = 'Equal healthcare'
panmatch_success_educ$type = 'Equal education'
panmatch_vis = bind_rows(panmatch_eqdr, panmatch_success_health, panmatch_success_educ)

ggplot(panmatch_vis, aes(x = t, y = E, color = type)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    title = "ATT of democratizing successful campaigns",
    subtitle = 'Only 3 campaigns are violent. Delta values',
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1))
```

Failed autocratizing campaigns - all types of vdem inequality
```{r}
df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "failed_autoc_5yr", "v2xeg_eqdr")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "failed_autoc_5yr", "v2pehealth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4))  + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "failed_autoc_5yr", "v2peedueq")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4))  + I(lag(v2peedueq, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr$type = "Equal resources distribution"
panmatch_success_health$type = 'Equal healthcare'
panmatch_success_educ$type = 'Equal education'
panmatch_vis = bind_rows(panmatch_eqdr, panmatch_success_health, panmatch_success_educ)

ggplot(panmatch_vis, aes(x = t, y = E, color = type)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    title = "ATT of autocratizing failed campaigns",
    #subtitle = 'V-Dem polyarchy growth rates (%). 1900-2014',
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1))
```

Failed campaigns
```{r}
df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_FAILURE", "v2xeg_eqdr")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_FAILURE", "v2pehealth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4))  + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_FAILURE", "v2peedueq")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4))  + I(lag(v2peedueq, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr$type = "Equal resources distribution"
panmatch_success_health$type = 'Equal healthcare'
panmatch_success_educ$type = 'Equal education'
panmatch_vis = bind_rows(panmatch_eqdr, panmatch_success_health, panmatch_success_educ)

ggplot(panmatch_vis, aes(x = t, y = E, color = type)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    title = "ATT of failed campaigns",
    #subtitle = 'V-Dem polyarchy growth rates (%). 1900-2014',
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1))
```

Violent failed campaigns
```{r}
df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_violfailed", "v2xeg_eqdr")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_violfailed", "v2pehealth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4))  + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_violfailed", "v2peedueq")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4))  + I(lag(v2peedueq, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr$type = "Equal resources distribution"
panmatch_success_health$type = 'Equal healthcare'
panmatch_success_educ$type = 'Equal education'
panmatch_vis = bind_rows(panmatch_eqdr, panmatch_success_health, panmatch_success_educ)

ggplot(panmatch_vis, aes(x = t, y = E, color = type)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    title = "ATT of violent failed campaigns",
    #subtitle = 'V-Dem polyarchy growth rates (%). 1900-2014',
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1))
```

Difference between successful democratizing revolution and democratization without a revolution. Equal distribution index
```{r}
df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2xeg_eqdr")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2pehealth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2peedueq")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2peedueq, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr$type = "Equal resources distribution"
panmatch_success_health$type = 'Equal healthcare'
panmatch_success_educ$type = 'Equal education'
panmatch_vis = bind_rows(panmatch_eqdr, panmatch_success_health, panmatch_success_educ)
panmatch_vis$type2 = 'Successful democratizing revolutions'



df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "dem_without_revolution", "v2xeg_eqdr")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr_dem <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "dem_without_revolution", "v2pehealth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health_dem <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "dem_without_revolution", "v2peedueq")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2peedueq, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ_dem <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr_dem$type = "Equal resources distribution"
panmatch_success_health_dem$type = 'Equal healthcare'
panmatch_success_educ_dem$type = 'Equal education'
panmatch_vis_dem = bind_rows(panmatch_eqdr_dem, panmatch_success_health_dem, panmatch_success_educ_dem)
panmatch_vis_dem$type2 = 'Democratization without revolution'

panmatch_vis_fin = bind_rows(panmatch_vis, panmatch_vis_dem)


ggplot(panmatch_vis_fin, aes(x = t, y = E, color = type)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    #title = "ATT",
    #subtitle = 'V-Dem polyarchy growth rates (%). 1900-2014',
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1)) +
  facet_wrap(~type2)

```

PanelMatch. Successful revolution and successful democratizing revolutions

```{r}
df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2xeg_eqdr")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2pehealth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "success_dem_5yr", "v2peedueq")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2peedueq, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr$type = "Equal resources distribution"
panmatch_success_health$type = 'Equal healthcare'
panmatch_success_educ$type = 'Equal education'
panmatch_vis = bind_rows(panmatch_eqdr, panmatch_success_health, panmatch_success_educ)
panmatch_vis$type2 = 'Successful democratizing revolutions'



df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_SUCCESS", "v2xeg_eqdr")

PM.results_success_eqdr <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2xeg_eqdr, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_eqdr,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2xeg_eqdr"
  )
))

PE.results_success_eqdr <- PanelEstimate(
  sets = PM.results_success_eqdr, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_eqdr_dem <- PE.results_success_eqdr$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_eqdr$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_eqdr$estimate %>% as.data.frame(),
    PE.results_success_eqdr$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_SUCCESS", "v2pehealth")

PM.results_success_health <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2pehealth, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_health,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2pehealth"
  )
))

PE.results_success_health <- PanelEstimate(
  sets = PM.results_success_health, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_health_dem <- PE.results_success_health$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_health$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_health$estimate %>% as.data.frame(),
    PE.results_success_health$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

df_PM_semgus <- PanelData(df_semgus, "wbcode2", "year", "NVC1.3_SUCCESS", "v2peedueq")

PM.results_success_educ <- PanelMatch(
  lag = 4,
  panel.data = df_PM_semgus,
  refinement.method = "mahalanobis", match.missing = TRUE, use.diagonal.variance.matrix = F,
  covs.formula = ~ I(lag(v2x_polyarchy, 1:4)) + I(lag(v2x_polyarchy^2, 1:4))+ I(lag(gdp_pcap, 1:4)) + I(lag(pop, 1:4)) + I(lag(v2peedueq, 1:4)),
  #  exact.match.variables = 'region_int',
  size.match = 10, qoi = "att",
  lead = 0:10, forbid.treatment.reversal = FALSE,
  placebo.test = T
)

print(get_covariate_balance(PM.results_success_educ,
  panel.data = df_PM_semgus,
  covariates = c(
    "v2x_polyarchy", "gdp_pcap", "pop", "v2peedueq"
  )
))

PE.results_success_educ <- PanelEstimate(
  sets = PM.results_success_educ, panel.data = df_PM_semgus,
  se.method = "bootstrap", number.iterations = 1000, confidence.level = .95, parallel = T, num.cores = 8,
  include.placebo.test = T, # moderator = 'region',
)

panmatch_success_educ_dem <- PE.results_success_educ$placebo.test$estimates %>%
  as.data.frame() %>%
  cbind(., PE.results_success_educ$placebo.test$standard.errors %>% as.data.frame()) %>%
  rename(E = 1, SE = 2) %>%
  rbind(cbind(
    PE.results_success_educ$estimate %>% as.data.frame(),
    PE.results_success_educ$standard.error %>% as.data.frame()
  ) %>% rename(E = 1, SE = 2)) %>%
  rownames_to_column(var = "time") %>%
  add_row(E = 0, SE = 0, time = "t-1") %>% # Добавляем строку
  arrange(as.numeric(gsub("t[+]", "", gsub("t-", "-", time)))) %>%
  mutate(t = 1:n() - 4)

panmatch_eqdr_dem$type = "Equal resources distribution"
panmatch_success_health_dem$type = 'Equal healthcare'
panmatch_success_educ_dem$type = 'Equal education'
panmatch_vis_dem = bind_rows(panmatch_eqdr_dem, panmatch_success_health_dem, panmatch_success_educ_dem)
panmatch_vis_dem$type2 = 'Successful revolutions'

panmatch_vis_fin = bind_rows(panmatch_vis, panmatch_vis_dem)


ggplot(panmatch_vis_fin, aes(x = t, y = E, color = type)) +
  geom_pointrange(aes(ymin = E - 1.96 * SE, ymax = E + 1.96 * SE), 
                  position = position_dodge(width = 0.5)) +  
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line() +
  labs(
    #title = "ATT",
    #subtitle = 'V-Dem polyarchy growth rates (%). 1900-2014',
    x = "t",
    y = "ATT",
    color = "Type"  # Подпись легенды
  ) +
  theme_bw() +  # Минималистичная тема
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Центрирование заголовка
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"  # Легенда внизу
  ) +
  scale_x_continuous(breaks = seq(-4,10,1)) +
  facet_wrap(~type2)
```

